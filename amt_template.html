<!-- Bootstrap CSS と jQuery を最初に読み込む（AMTテンプレートと同じ） -->
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" integrity="sha384-IS73LIqjtYesmURkDE9MXKbXqYA8rvKEp/ghicjem7Vc3mGRdQRptJSz60tvrB6+" rel="stylesheet" />

<style type="text/css">
    #collapseTrigger{
        color:#fff;
        display: block;
        text-decoration: none;
    }
    #submitButton{
        white-space: normal;
    }
    .image{
        margin-bottom: 15px; 
    }
    /* CSS for breaking long words/urls */
    .dont-break-out {
        overflow-wrap: break-word;
        word-wrap: break-word;
        -ms-word-break: break-all;
        word-break: break-all;
        word-break: break-word;
        -ms-hyphens: auto;
        -moz-hyphens: auto;
        -webkit-hyphens: auto;
        hyphens: auto;
    }
    /* Original layout styles */
    .amt-container {
        max-width: 100%; /* 最大幅を100%に */
        margin: 0;
        padding: 10px; /* パディングを減らす */
    }
    .instructions {
        background: #f0f0f0;
        padding: 15px; /* パディングを減らす */
        border-radius: 8px;
        margin-bottom: 15px; /* マージンを減らす */
    }
    .instructions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px; /* ギャップを減らす */
        margin-bottom: 20px;
    }
    .instructions-column h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-column ul {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-column li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .instructions-workflow h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-workflow ol {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-workflow li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .iframe-container {
        width: 100%;
        height: 850px; /* 高さをさらに減らす */
        border: 1px solid #ddd; /* ボーダーを細く */
        border-radius: 5px;
        margin: 0 -10px; /* ネガティブマージンで横幅を拡張 */
        padding: 0 10px;
    }
    #annotation-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* 画面サイズに応じてiframeの高さを調整 */
    @media (max-width: 1200px) {
        .iframe-container {
            height: 1100px; /* 縦並びレイアウト用に高さを増やす */
        }
    }
    
    .confirmation-box {
        background: #e8f5e9;
        border: 2px solid #4CAF50;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .percentage-display {
        font-size: 24px;
        font-weight: bold;
        color: #2e7d32;
        text-align: center;
        margin: 15px 0;
    }
    
    .checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
    }
    
    .checkbox-container input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
    }
    
    .checkbox-container label {
        font-size: 16px;
        font-weight: normal;
        margin: 0;
        cursor: pointer;
    }

</style>

<meta content="width=device-width,initial-scale=1" name="viewport" />

<section class="container-fluid" id="VideoSummarization" style="max-width: 100%; padding: 0;">
    <div class="amt-container">
        <div class="instructions">
            <h2>Multi-Video Summarization Task</h2>
            <p>In this task, you will watch a single video that contains 5 concatenated videos about <strong>${city_name}</strong>. Please select the most representative, impressive, and unique scenes that best summarize the city from this combined video.</p>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid #ffeaa7;">
                <strong>⚠️ IMPORTANT:</strong> 
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>After watching the video and selecting segments, use the "Preview Selected Segments" button to review your choices.</li>
                    <li>The "Save Results" button will appear only after you use the preview function.</li>
                    <li>You MUST click "Save Results" to save your selections before submitting the HIT.</li>
                </ul>
            </div>
            
            <div class="instructions-grid">
                <div class="instructions-column">
                    <h3>Selection Criterion</h3>
                    <ul>
                        <li>Watch the entire concatenated video to understand all available content about the city.</li>
                        <li>Choose the most attractive, clear, or visually impressive segments from all segments.</li>
                        <li>Avoid selecting duplicate or similar content - if the same scene appears multiple times, choose only the best version.</li>
                        <li>The total length of selected segments should be between <strong>5% and 15%</strong> of the overall video duration.</li>
                        <li>Focus on scenes that uniquely represent the city's characteristics and appeal.</li>
                        <li>Audio is muted, so please base your judgment only on visuals.</li>
                        <li>Do not consider temporary on-screen text as the main reason to judge importance.</li>
                    </ul>
                </div>
                
                <div class="instructions-column">
                    <h3>Interface Operations</h3>
                    <ul>
                        <li><strong>Video Navigation:</strong> Use video controls to play, pause, seek through the video, and adjust playback speed.</li>
                        <li><strong>Segment Selection:</strong> Click on segment tiles below the video to jump to that segment.</li>
                        <li><strong>Include/Remove:</strong> Click the "Include" button on segment tiles to select them for the summary.</li>
                        <li><strong>Quick Include:</strong> Use the "Include Current Segment" button to select the segment at current playback position.</li>
                        <li><strong>Currently Playing Indicator:</strong> The segment currently being played is highlighted with a blue border and pulsing animation, making it easy to identify which segment you're watching.</li>
                        <li><strong>Preview Function:</strong> After watching the entire video, the "Preview Selected Segments" button will appear. Use it to watch only your selected segments in sequence. During preview, segments will be highlighted in red.</li>
                        <li><strong>Save Function:</strong> The "Save Results" button appears only after using the preview function. You must click it to save your selections.</li>
                        <li><strong>Statistics:</strong> Monitor your selection progress using the stats at the top (aim for 5-15%).</li>
                    </ul>
                </div>
            </div>
            
            <div class="instructions-workflow">
                <h3>Workflow</h3>
                <ol>
                    <li>Check the name of the tourist city provided as the query (<strong>${city_name}</strong>).</li>
                    <li>Watch the entire concatenated video to get an overview of all available content. You must watch the full video before proceeding. It is acceptable to use playback speed controls or seek through the video to navigate efficiently.</li>
                    <li>Select segments that you think are important for representing the city. The currently playing segment will be highlighted in blue to help you track your position.</li>
                    <li>After watching the entire video, the "Preview Selected Segments" button will appear. Use it to review your selections. During preview, selected segments will play in order with a red highlight.</li>
                    <li><strong>When duplicate content appears, remove the segments with relatively lower importance. However, if adjacent segments contain similar content, you may keep both.</strong></li>
                    <li>Monitor the percentage indicator to ensure your selection is between 5% and 15%.</li>
                    <li>After using the preview function, the "Save Results" button will appear. Press it to save your selections.</li>
                    <li>After seeing "Selection saved!" message, check the confirmation checkbox and click Submit.</li>
                </ol>
            </div>
        </div>
        
        <div class="iframe-container">
            <iframe id="annotation-iframe"></iframe>
        </div>
        
        <!-- Status and submission section -->
        <div style="background: #f0f0f0; padding: 20px; margin-top: 20px; border-radius: 8px; text-align: center;">
            <div id="status-message" style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">
                Please make your selections in the interface above.<br>
                After watching the entire video, a 'Preview Selected Segments' button will appear.<br>
                Once you have previewed your selections, the 'Save Results' button will become available.
            </div>
            <div id="completion-message" style="display: none; margin-top: 15px; color: #4CAF50; font-size: 18px; font-weight: bold;">
                ✓ Selection saved successfully! You can now submit the HIT.
            </div>
        </div>
        
        <!-- Hidden inputs for data -->
        <input type="hidden" name="results" id="results-input" />
        <input type="hidden" name="city" value="${city_name}" />
        <input type="hidden" name="area" value="${area}" />
        <input type="hidden" name="place" value="${place}" />
        <input type="hidden" name="task_completed" id="task-completed-input" value="false" />
        <input type="hidden" name="percentage_confirmed" id="percentage-confirmed-input" value="false" />
        
        <!-- Confirmation section - Hidden until task is completed -->
        <div class="form-group confirmation-box" id="submission-section" style="display: none;">
            <h4 style="text-align: center; color: #2e7d32; margin-bottom: 20px;">Task Completed Successfully!</h4>
            
            <div class="percentage-display">
                Your selected segments: <span id="final-percentage">0%</span> of total video
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="confirmation-checkbox" name="confirmation_checkbox" required>
                <label for="confirmation-checkbox">
                    I confirm that my selected segments are between 5% and 15% of the total video duration
                </label>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 14px; margin-top: 15px;">
                Please check the box above to confirm your selection percentage before submitting.
            </p>
        </div>
        <!-- End confirmation section -->
    </div>
</section>

<!-- External JS references -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" integrity="sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        // Configuration
        const GITHUB_PAGES_URL = 'https://sugitomoo.github.io/MVS_city_concat/';
        const GITHUB_PAGES_ORIGIN = 'https://sugitomoo.github.io';
        
        const cityData = {
            area: '${area}',
            place: '${place}',
            cityName: '${city_name}'
        };
        
        // Initialize iframe
        const iframe = document.getElementById('annotation-iframe');
        const params = new URLSearchParams({
            area: cityData.area,
            place: cityData.place,
            city: cityData.cityName,
            mode: 'amt'
        });
        
        iframe.src = GITHUB_PAGES_URL + '?' + params.toString();
        
        // State management
        let currentResults = null;
        let taskCompleted = false;
        let savedPercentage = 0;
        
        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            // Only accept messages from GitHub Pages
            if (event.origin !== GITHUB_PAGES_ORIGIN) return;
            
            if (event.data.type === 'results-saved') {
                currentResults = event.data.results;
                savedPercentage = currentResults.percentage;
                
                // Check if percentage is within 5-15% range
                if (currentResults.percentage >= 5 && currentResults.percentage <= 15) {
                    // Save to hidden form
                    document.getElementById('results-input').value = JSON.stringify(currentResults);
                    document.getElementById('task-completed-input').value = 'true';
                    
                    // Update UI
                    document.getElementById('status-message').style.display = 'none';
                    document.getElementById('completion-message').style.display = 'block';
                    
                    // Update percentage display
                    document.getElementById('final-percentage').textContent = currentResults.percentage.toFixed(1) + '%';
                    
                    taskCompleted = true;
                    
                    // Show submission section
                    document.getElementById('submission-section').style.display = 'block';
                    
                    // Scroll to the form area
                    document.getElementById('submission-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                } else {
                    document.getElementById('status-message').innerHTML =
                      '<span style="color: #f44336;">Selection must be between 5% and 15%. Current: ' + currentResults.percentage.toFixed(1) + '%</span>';
                    alert(
                      'Selection must be between 5% and 15% of total duration.\n\n' +
                      'Current: ' + currentResults.percentage.toFixed(1) + '%\n' +
                      (currentResults.percentage < 5
                        ? 'Please select more segments.'
                        : 'Please remove some segments.')
                    );
                    
                    taskCompleted = false;
                    document.getElementById('task-completed-input').value = 'false';
                    
                    // Hide confirmation section if percentage is out of range
                    document.getElementById('submission-section').style.display = 'none';
                }
            }
        });
        
        // Handle checkbox change
        $('#confirmation-checkbox').on('change', function() {
            const isChecked = $(this).is(':checked');
            $('#percentage-confirmed-input').val(isChecked ? 'true' : 'false');
        });
        
        // Prevent form submission if task not completed
        $('form').on('submit', function(e) {
            if (!taskCompleted) {
                e.preventDefault();
                alert('Please complete the video summarization task and save your results before submitting.');
                return false;
            }
            
            const isConfirmed = $('#confirmation-checkbox').is(':checked');
            if (!isConfirmed) {
                e.preventDefault();
                alert('Please check the confirmation box to confirm that your selection is between 5% and 15% of the total video duration.');
                return false;
            }
            
            // Double check the percentage one more time
            if (savedPercentage < 5 || savedPercentage > 15) {
                e.preventDefault();
                alert('Error: Your selection is not within the required 5-15% range. Please adjust your selection.');
                return false;
            }
            
            return true;
        });
    });
</script>