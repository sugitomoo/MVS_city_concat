<!-- Bootstrap CSS と jQuery を最初に読み込む（AMTテンプレートと同じ） -->
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" integrity="sha384-IS73LIqjtYesmURkDE9MXKbXqYA8rvKEp/ghicjem7Vc3mGRdQRptJSz60tvrB6+" rel="stylesheet" />

<style type="text/css">
    #collapseTrigger{
        color:#fff;
        display: block;
        text-decoration: none;
    }
    #submitButton{
        white-space: normal;
    }
    .image{
        margin-bottom: 15px; 
    }
    /* CSS for breaking long words/urls */
    .dont-break-out {
        overflow-wrap: break-word;
        word-wrap: break-word;
        -ms-word-break: break-all;
        word-break: break-all;
        word-break: break-word;
        -ms-hyphens: auto;
        -moz-hyphens: auto;
        -webkit-hyphens: auto;
        hyphens: auto;
    }
    /* Original layout styles */
    .amt-container {
        max-width: 100%; /* 最大幅を100%に */
        margin: 0;
        padding: 10px; /* パディングを減らす */
    }
    .instructions {
        background: #f0f0f0;
        padding: 15px; /* パディングを減らす */
        border-radius: 8px;
        margin-bottom: 15px; /* マージンを減らす */
    }
    .instructions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px; /* ギャップを減らす */
        margin-bottom: 20px;
    }
    .instructions-column h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-column ul {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-column li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .instructions-workflow h3 {
        color: #2c3e50;
        font-size: 18px;
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 8px;
    }
    .instructions-workflow ol {
        margin: 0;
        padding-left: 20px;
    }
    .instructions-workflow li {
        color: #495057;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 8px;
    }
    .iframe-container {
        width: 100%;
        height: 850px; /* 高さをさらに減らす */
        border: 1px solid #ddd; /* ボーダーを細く */
        border-radius: 5px;
        margin: 0 -10px; /* ネガティブマージンで横幅を拡張 */
        padding: 0 10px;
    }
    #annotation-iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* 画面サイズに応じてiframeの高さを調整 */
    @media (max-width: 1200px) {
        .iframe-container {
            height: 1100px; /* 縦並びレイアウト用に高さを増やす */
        }
    }
    
    /* Submit button disabled state */
    #submit-button:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.65;
    }
    
    .confirmation-code {
        font-family: monospace;
        font-size: 18px;
        font-weight: bold;
        color: #28a745;
        background: #f0f0f0;
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
    }

</style>

<meta content="width=device-width,initial-scale=1" name="viewport" />

<section class="container-fluid" id="VideoSummarization" style="max-width: 100%; padding: 0;">
    <div class="amt-container">
        <div class="instructions">
            <h2>Multi-Video Summarization Task</h2>
            <p>In this task, you will watch a single video that contains 5 concatenated videos about <strong>${city_name}</strong>. Please select the most representative, impressive, and unique scenes that best summarize the city from this combined video.</p>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid #ffeaa7;">
                <strong>⚠️ IMPORTANT:</strong> 
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    <li>After watching the video and selecting segments, use the "Preview Selected Segments" button to review your choices.</li>
                    <li>The "Save Results" button will appear only after you use the preview function.</li>
                    <li>You MUST click "Save Results" to receive a confirmation code.</li>
                    <li>You cannot submit this HIT without the confirmation code.</li>
                </ul>
            </div>
            
            <div class="instructions-grid">
                <div class="instructions-column">
                    <h3>Selection Criterion</h3>
                    <ul>
                        <li>Watch the entire concatenated video to understand all available content about the city.</li>
                        <li>Choose the most attractive, clear, or visually impressive segments from all segments.</li>
                        <li>Avoid selecting duplicate or similar content - if the same scene appears multiple times, choose only the best version.</li>
                        <li>The total length of selected segments should be between <strong>5% and 15%</strong> of the overall video duration.</li>
                        <li>Focus on scenes that uniquely represent the city's characteristics and appeal.</li>
                        <li>Audio is muted, so please base your judgment only on visuals.</li>
                        <li>Do not consider temporary on-screen text as the main reason to judge importance.</li>
                    </ul>
                </div>
                
                <div class="instructions-column">
                    <h3>Interface Operations</h3>
                    <ul>
                        <li><strong>Video Navigation:</strong> Use video controls to play, pause, seek through the video, and adjust playback speed.</li>
                        <li><strong>Segment Selection:</strong> Click on segment tiles below the video to jump to that segment.</li>
                        <li><strong>Include/Remove:</strong> Click the "Include" button on segment tiles to select them for the summary.</li>
                        <li><strong>Quick Include:</strong> Use the "Include Current Segment" button to select the segment at current playback position.</li>
                        <li><strong>Currently Playing Indicator:</strong> The segment currently being played is highlighted with a blue border and pulsing animation, making it easy to identify which segment you're watching.</li>
                        <li><strong>Preview Function:</strong> After watching the entire video, the "Preview Selected Segments" button will appear. Use it to watch only your selected segments in sequence. During preview, segments will be highlighted in red.</li>
                        <li><strong>Save Function:</strong> The "Save Results" button appears only after using the preview function. You must click it to save your selections.</li>
                        <li><strong>Statistics:</strong> Monitor your selection progress using the stats at the top (aim for 5-15%).</li>
                    </ul>
                </div>
            </div>
            
            <div class="instructions-workflow">
                <h3>Workflow</h3>
                <ol>
                    <li>Check the name of the tourist city provided as the query (<strong>${city_name}</strong>).</li>
                    <li>Watch the entire concatenated video to get an overview of all available content. You must watch the full video before proceeding. It is acceptable to use playback speed controls or seek through the video to navigate efficiently.</li>
                    <li>Select segments that you think are important for representing the city. The currently playing segment will be highlighted in blue to help you track your position.</li>
                    <li>After watching the entire video, the "Preview Selected Segments" button will appear. Use it to review your selections. During preview, selected segments will play in order with a red highlight.</li>
                    <li><strong>When duplicate content appears, remove the segments with relatively lower importance. However, if adjacent segments contain similar content, you may keep both.</strong></li>
                    <li>Monitor the percentage indicator to ensure your selection is between 5% and 15%.</li>
                    <li>After using the preview function, the "Save Results" button will appear. Press it to save your selections.</li>
                    <li>After saving, you will receive a confirmation code. Enter this code in the field below.</li>
                    <li>Click the "Submit" button to complete the HIT.</li>
                </ol>
            </div>
        </div>
        
        <div class="iframe-container">
            <iframe id="annotation-iframe"></iframe>
        </div>
        
        <!-- Status and submission section -->
        <div style="background: #f0f0f0; padding: 20px; margin-top: 20px; border-radius: 8px; text-align: center;">
            <div id="status-message" style="margin-bottom: 15px; font-size: 16px; font-weight: bold;">
                Please make your selections in the interface above.<br>
                After watching the entire video, a 'Preview Selected Segments' button will appear.<br>
                Once you have previewed your selections, the 'Save Results' button will become available.
            </div>
            <div id="completion-message" style="display: none; margin-top: 15px; color: #4CAF50; font-size: 18px; font-weight: bold;">
                ✓ Task completed successfully!<br>
                Your confirmation code is: <span class="confirmation-code" id="confirmation-code-display"></span><br>
                Please enter this code in the field below to submit.
            </div>
        </div>
        
        <!-- Hidden inputs for data -->
        <input type="hidden" name="results" id="results-input" />
        <input type="hidden" name="city" value="${city_name}" />
        <input type="hidden" name="area" value="${area}" />
        <input type="hidden" name="place" value="${place}" />
        <input type="hidden" name="confirmation_code" id="hidden-confirmation-code" />
        
        <!-- Input from Worker (AMTテンプレートと同じ形式) -->
        <div class="form-group" style="margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
            <label for="confirmation">Enter your confirmation code:</label>
            <input class="form-control" id="confirmation" name="confirmation" placeholder="Enter the confirmation code you received after saving" required="" type="text" />
            <small class="form-text text-muted">You must save your results first to receive a confirmation code.</small>
        </div>
        
        <!-- Submit button - Initially disabled -->
        <div style="text-align: center; margin-top: 20px;">
            <button type="submit" id="submit-button" class="btn btn-primary btn-lg" disabled>Submit HIT</button>
            <div id="submit-error" style="color: #dc3545; margin-top: 10px; display: none;"></div>
        </div>
        <!-- End input from Worker -->
    </div>
</section>

<!-- External JS references -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" integrity="sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4" crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        // Configuration - Updated for concatenated version
        const GITHUB_PAGES_URL = 'https://sugitomoo.github.io/MVS_city_concat/';
        const GITHUB_PAGES_ORIGIN = 'https://sugitomoo.github.io';
        
        const cityData = {
            area: '${area}',
            place: '${place}',
            cityName: '${city_name}'
        };
        
        // Initialize iframe
        const iframe = document.getElementById('annotation-iframe');
        const params = new URLSearchParams({
            area: cityData.area,
            place: cityData.place,
            city: cityData.cityName,
            mode: 'amt'
        });
        
        iframe.src = GITHUB_PAGES_URL + '?' + params.toString();
        
        // State management
        let currentResults = null;
        let taskCompleted = false;
        let confirmationCode = null;
        
        // Generate confirmation code
        function generateConfirmationCode() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `MVS-${random}-${timestamp.toString(36).toUpperCase()}`;
        }
        
        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            // Only accept messages from GitHub Pages
            if (event.origin !== GITHUB_PAGES_ORIGIN) return;
            
            if (event.data.type === 'results-saved') {
                currentResults = event.data.results;
                
                // Check if percentage is within 5-15% range
                if (currentResults.percentage >= 5 && currentResults.percentage <= 15) {
                    // Generate confirmation code
                    confirmationCode = generateConfirmationCode();
                    
                    // Save to hidden form (without modifying the results data)
                    document.getElementById('results-input').value = JSON.stringify(currentResults);
                    document.getElementById('hidden-confirmation-code').value = confirmationCode;
                    
                    // Update UI
                    document.getElementById('status-message').style.display = 'none';
                    document.getElementById('completion-message').style.display = 'block';
                    document.getElementById('confirmation-code-display').textContent = confirmationCode;
                    
                    taskCompleted = true;
                    
                    // Scroll to the form area
                    document.querySelector('.form-group').scrollIntoView({ behavior: 'smooth' });
                    
                    // Focus on confirmation input
                    document.getElementById('confirmation').focus();
                    
                } else {
                    document.getElementById('status-message').innerHTML =
                      '<span style="color: #f44336;">Selection must be between 5% and 15%. Current: ' + currentResults.percentage.toFixed(1) + '%</span>';
                    alert(
                      'Selection must be between 5% and 15% of total duration.\n\n' +
                      'Current: ' + currentResults.percentage.toFixed(1) + '%\n' +
                      (currentResults.percentage < 5
                        ? 'Please select more segments.'
                        : 'Please remove some segments.')
                    );
                    
                    taskCompleted = false;
                }
            }
        });
        
        // Validate confirmation code on input
        $('#confirmation').on('input', function() {
            const enteredCode = $(this).val().trim();
            const submitButton = $('#submit-button');
            const submitError = $('#submit-error');
            
            if (taskCompleted && confirmationCode && enteredCode === confirmationCode) {
                submitButton.prop('disabled', false);
                submitError.hide();
            } else {
                submitButton.prop('disabled', true);
                
                if (enteredCode && !taskCompleted) {
                    submitError.text('Please complete the task first to receive a confirmation code.').show();
                } else if (enteredCode && taskCompleted && enteredCode !== confirmationCode) {
                    submitError.text('Invalid confirmation code. Please enter the exact code shown above.').show();
                } else {
                    submitError.hide();
                }
            }
        });
        
        // Handle form submission
        $('#submit-button').on('click', function(e) {
            e.preventDefault();
            
            const enteredCode = $('#confirmation').val().trim();
            
            if (!taskCompleted) {
                alert('Please complete the task before submitting.');
                return false;
            }
            
            if (enteredCode !== confirmationCode) {
                alert('Invalid confirmation code. Please enter the correct code.');
                return false;
            }
            
            // If we're in AMT environment, submit the form
            if (typeof submitForm === 'function') {
                submitForm();
            } else {
                // For testing
                alert('Form would be submitted with code: ' + confirmationCode);
            }
        });
    });
</script>